---
import { getCollection, render } from "astro:content";
import "../../styles/main.css";
import { SEO } from "astro-seo";
import { ViewTransitions } from "astro:transitions";

export const prerender = true;

const SITE_URL = "https://tomodevelops.com";

export async function getStaticPaths() {
    const posts = await getCollection("blog");
    return posts.map((post) => ({
        params: { slug: post.id },
        props: { post },
    }));
}

const { post } = Astro.props;
const { Content } = await render(post);

function formatDate(date: Date, lang: string): string {
    return date.toLocaleDateString(lang === "ja" ? "ja-JP" : "en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
}

const lang = post.data.lang;
const canonicalUrl = `${SITE_URL}/blog/${post.id}`;
const pageTitle = `${post.data.title} | TomoDevelops`;
const ogImage = post.data.image
    ? (post.data.image.startsWith("http") ? post.data.image : `${SITE_URL}${post.data.image}`)
    : `${SITE_URL}/images/og-default.png`;

const blogPostJsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: post.data.title,
    description: post.data.description,
    url: canonicalUrl,
    image: ogImage,
    datePublished: post.data.date.toISOString(),
    author: {
        "@type": "Person",
        name: "TomoDevelops",
        url: SITE_URL,
    },
    publisher: {
        "@type": "Person",
        name: "TomoDevelops",
        url: SITE_URL,
    },
    ...(post.data.tags && { keywords: post.data.tags.join(", ") }),
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": canonicalUrl,
    },
};
---

<html lang={lang}>
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <SEO
            title={pageTitle}
            description={post.data.description}
            canonical={canonicalUrl}
            openGraph={{
                basic: {
                    title: pageTitle,
                    type: "article",
                    image: ogImage,
                    url: canonicalUrl,
                },
                optional: {
                    siteName: "TomoDevelops",
                    locale: lang === "ja" ? "ja_JP" : "en_US",
                },
                article: {
                    publishedTime: post.data.date.toISOString(),
                    authors: ["TomoDevelops"],
                    tags: post.data.tags,
                },
            }}
            twitter={{
                card: "summary_large_image",
                site: "@tomodevelops",
                creator: "@tomodevelops",
            }}
        />
        <script type="application/ld+json" set:html={JSON.stringify(blogPostJsonLd)} />
        <ViewTransitions />
        <link
            rel="preload"
            href="/fonts/Terminess-Regular.ttf"
            as="font"
            type="font/ttf"
            crossorigin="anonymous"
        />
        <link
            rel="preload"
            href="/fonts/Terminess-Bold.ttf"
            as="font"
            type="font/ttf"
            crossorigin="anonymous"
        />
    </head>
    <body class="antialiased selection:bg-green selection:text-navy" data-post-lang={lang}>
        <div class="min-h-screen">
            <header class="py-8 border-b border-lightest-navy/60">
                <div class="max-w-3xl mx-auto px-6 sm:px-8">
                    <a
                        href="/blog"
                        class="text-slate/70 hover:text-green transition-colors font-mono text-sm"
                    >
                        &larr; Back to Blog
                    </a>
                </div>
            </header>

            <main class="py-16 sm:py-20">
                <div class="max-w-3xl mx-auto px-6 sm:px-8">
                    <article>
                        <header class="mb-12">
                            <time
                                datetime={post.data.date.toISOString()}
                                class="text-sm font-mono text-slate/60"
                            >
                                {formatDate(post.data.date, lang)}
                            </time>
                            <h1 class="mt-4 text-3xl sm:text-4xl md:text-5xl font-bold text-lightest-slate tracking-tight leading-tight">
                                {post.data.title}
                            </h1>
                            <p class="mt-4 text-lg text-slate/85">
                                {post.data.description}
                            </p>
                            {post.data.tags && post.data.tags.length > 0 && (
                                <div class="flex flex-wrap gap-2 mt-6">
                                    {post.data.tags.map((tag) => (
                                        <span class="px-2.5 py-1 text-xs font-mono rounded border border-lightest-navy/60 text-slate/70 bg-lightest-navy/10">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            )}
                        </header>

                        <div class="prose prose-invert prose-slate max-w-none
                            prose-headings:text-lightest-slate prose-headings:font-bold prose-headings:tracking-tight
                            prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-4
                            prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
                            prose-p:text-slate prose-p:leading-relaxed prose-p:mb-6
                            prose-a:text-green prose-a:no-underline hover:prose-a:underline
                            prose-strong:text-lightest-slate prose-strong:font-bold
                            prose-code:text-green prose-code:bg-lightest-navy/20 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
                            prose-pre:bg-light-navy prose-pre:border prose-pre:border-lightest-navy/60 prose-pre:rounded-lg prose-pre:p-4 prose-pre:overflow-x-auto
                            prose-ul:text-slate prose-ul:space-y-2
                            prose-ol:text-slate prose-ol:space-y-2
                            prose-li:leading-relaxed
                            prose-blockquote:border-l-green prose-blockquote:text-slate/85 prose-blockquote:italic
                            prose-hr:border-lightest-navy/60
                        ">
                            <Content />
                        </div>
                    </article>
                </div>
            </main>

            <footer class="py-8 border-t border-lightest-navy/60">
                <div class="max-w-3xl mx-auto px-6 sm:px-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <a
                        href="/blog"
                        class="text-slate/70 hover:text-green transition-colors font-mono text-sm"
                    >
                        &larr; Back to Blog
                    </a>
                    <p class="text-xs text-slate/60 font-mono">
                        &copy; 2026 TomoDevelops
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>
